<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT File Power Curve Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Basic body styling */
        body { font-family: 'Inter', sans-serif; }
        /* Ensure canvas is responsive */
        .chart-container {
            position: relative;
            margin: 2rem auto; /* Add some margin */
            height: 60vh;
            width: 80vw;
            max-width: 900px;
        }
        /* Style for loading/error/status messages */
        .status-message {
            min-height: 1.5em; /* Reserve space */
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 500;
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .status-error { background-color: #fee2e2; color: #dc2626; } /* red-100 / red-600 */
        .status-success { background-color: #dcfce7; color: #16a34a; } /* green-100 / green-600 */
        .status-info { background-color: #e0f2fe; color: #0284c7; } /* sky-100 / sky-600 */

        /* Hide elements by default */
        .hidden { display: none; }

        /* Basic button styling */
        button, input[type="submit"] {
            transition: background-color 0.2s ease;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 1rem;
            font-weight: 600;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary { background-color: #4f46e5; color: white; } /* indigo-600 */
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; } /* indigo-700 */
        .btn-secondary { background-color: #e5e7eb; color: #374151; } /* gray-200 / gray-700 */
        .btn-secondary:hover:not(:disabled) { background-color: #d1d5db; } /* gray-300 */
        .btn-danger { background-color: #dc2626; color: white; } /* red-600 */
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; } /* red-700 */

        /* Input field styling */
        input[type="text"], input[type="password"], input[type="date"], input[type="file"] {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem;
            width: 100%;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        input[type="file"] { padding: 0.3rem 0.75rem; }
        input:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #6366f1; box-shadow: 0 0 0 2px #a5b4fc; } /* indigo-500 focus */

        /* Style for file list items */
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .file-item:last-child { border-bottom: none; }

        /* Styling for active navigation button */
        .nav-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .nav-button {
            margin-right: 0.5rem; /* Add some spacing between nav buttons */
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <header class="flex justify-between items-center mb-6 max-w-5xl mx-auto">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Power Curve Analyzer</h1>
        <div id="userStatusArea">
            <span id="userInfo" class="hidden mr-4 text-gray-700"></span>
            <button id="logoutButton" class="btn-secondary hidden">Logout</button>
            <button id="showLoginButton" class="btn-primary">Login</button>
            <button id="showRegisterButton" class="btn-secondary ml-2">Register</button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto">

        <section id="loginSection" class="hidden max-w-sm mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-600 mb-1">Username:</label>
                    <input type="text" id="loginUsername" name="username" required autocomplete="username">
                </div>
                <div class="mb-4">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-600 mb-1">Password:</label>
                    <input type="password" id="loginPassword" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary w-full">Login</button>
                <div id="loginStatusMessage" class="status-message"></div>
            </form>
        </section>

        <section id="registerSection" class="hidden max-w-sm mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">Register</h2>
            <form id="registerForm">
                <div class="mb-4">
                    <label for="registerUsername" class="block text-sm font-medium text-gray-600 mb-1">Username:</label>
                    <input type="text" id="registerUsername" name="username" required minlength="3" autocomplete="username">
                </div>
                <div class="mb-4">
                    <label for="registerPassword" class="block text-sm font-medium text-gray-600 mb-1">Password:</label>
                    <input type="password" id="registerPassword" name="password" required minlength="6" autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary w-full">Register</button>
                <div id="registerStatusMessage" class="status-message"></div>
            </form>
        </section>

        <nav id="mainNav" class="hidden mb-6 pb-2 border-b border-gray-300">
            <button data-view="files" class="nav-button btn-secondary">File Management</button>
            <button data-view="powercurve" class="nav-button btn-secondary">Power Curve Analysis</button>
            </nav>

        <div id="appViews">
            <section id="filesView" class="view-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">File Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Upload FIT Files</h3>
                        <form id="uploadForm">
                            <div class="mb-4">
                                <label for="fileInput" class="block text-sm font-medium text-gray-600 mb-1">Select .fit file(s):</label>
                                <input type="file" id="fileInput" name="file" accept=".fit" required multiple
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                            <button type="submit" id="uploadButton" class="btn-primary w-full">Upload Selected Files</button>
                            <div id="uploadStatusMessage" class="status-message"></div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Your Uploaded Files</h3>
                        <div id="fileListContainer" class="max-h-60 overflow-y-auto">
                            <p id="fileListPlaceholder" class="text-gray-500 text-center py-4">No files uploaded yet.</p>
                        </div>
                        <div id="fileListStatusMessage" class="status-message"></div>
                    </div>
                </div>
            </section>

            <section id="powerCurveView" class="view-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Power Curve Analysis</h2>
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Generate Power Curve</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-600 mb-1">Start Date:</label>
                            <input type="date" id="startDate" name="startDate" required>
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-medium text-gray-600 mb-1">End Date:</label>
                            <input type="date" id="endDate" name="endDate" required>
                        </div>
                        <button id="generateButton" class="btn-primary w-full">
                            Generate Power Curve
                        </button>
                    </div>
                     <div id="powerCurveStatusMessage" class="status-message"></div>
                </div>

                <div class="chart-container bg-white p-4 rounded-lg shadow-md">
                    <canvas id="powerCurveChart"></canvas>
                </div>
            </section>
            </div>

    </main>

    <script>
        // --- DOM Elements ---
        const userStatusArea = document.getElementById('userStatusArea');
        const userInfo = document.getElementById('userInfo');
        const logoutButton = document.getElementById('logoutButton');
        const showLoginButton = document.getElementById('showLoginButton');
        const showRegisterButton = document.getElementById('showRegisterButton');

        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        // const loggedInContent = document.getElementById('loggedInContent'); // This is now replaced by appViews

        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const uploadForm = document.getElementById('uploadForm');

        const loginStatusMessage = document.getElementById('loginStatusMessage');
        const registerStatusMessage = document.getElementById('registerStatusMessage');
        const uploadStatusMessage = document.getElementById('uploadStatusMessage');
        const fileListStatusMessage = document.getElementById('fileListStatusMessage');
        const powerCurveStatusMessage = document.getElementById('powerCurveStatusMessage');

        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileListPlaceholder = document.getElementById('fileListPlaceholder');

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const generateButton = document.getElementById('generateButton');
        const powerCurveChartElement = document.getElementById('powerCurveChart');

        let powerCurveChart = null; // Variable to hold the chart instance

        // --- NEW: View Management Elements and Logic ---
        const mainNav = document.getElementById('mainNav');
        const appViewsContainer = document.getElementById('appViews'); // Parent of all views
        const viewElements = { // Store references to view sections
            files: document.getElementById('filesView'),
            powercurve: document.getElementById('powerCurveView')
            // Add more views here: e.g., settings: document.getElementById('settingsView')
        };
        const navButtons = mainNav.querySelectorAll('.nav-button');


        /**
         * Shows a specific view and hides others. Updates URL hash.
         * @param {string} viewName - The key of the view to show (e.g., 'files', 'powercurve').
         */
        function showView(viewName) {
            let viewToShow = viewElements[viewName];

            // Default to 'files' view if the requested viewName is invalid or not found
            if (!viewToShow) {
                console.warn(`View "${viewName}" not found. Defaulting to "files".`);
                viewName = 'files'; // Set to default
                viewToShow = viewElements.files;
            }
            
            // Hide all views
            Object.values(viewElements).forEach(view => {
                if (view) view.classList.add('hidden');
            });

            // Show the target view
            if (viewToShow) {
                viewToShow.classList.remove('hidden');
            }

            // Update URL hash
            window.location.hash = viewName;

            // Update active state for navigation buttons
            navButtons.forEach(button => {
                if (button.dataset.view === viewName) {
                    button.classList.add('active', 'btn-primary');
                    button.classList.remove('btn-secondary');
                } else {
                    button.classList.remove('active', 'btn-primary');
                    button.classList.add('btn-secondary');
                }
            });
        }

        /**
         * Handles changes in the URL hash to switch views.
         */
        function handleRouteChange() {
            const hash = window.location.hash.substring(1); // Remove #
            // If logged in and hash is empty or invalid, default to 'files'
            // If not logged in, this function might not be called or should do nothing if called.
            if (current_user.is_authenticated) { // Check if user is logged in before routing
                 showView(hash || 'files'); // Default to 'files' view if hash is empty
            }
        }

        // Event listener for navigation buttons
        if (mainNav) {
            mainNav.addEventListener('click', (event) => {
                const targetButton = event.target.closest('button[data-view]');
                if (targetButton) {
                    const viewName = targetButton.dataset.view;
                    showView(viewName);
                }
            });
        }
        // --- END NEW View Management Logic ---


        // --- Helper Functions ---

        /**
         * Sets a status message in a designated element.
         * @param {HTMLElement} element - The DOM element to display the message in.
         * @param {string} message - The message text.
         * @param {'error' | 'success' | 'info' | 'clear'} type - The type of message.
         */
        function setStatusMessage(element, message, type = 'info') {
            if (!element) return;
            element.textContent = message;
            element.className = 'status-message'; // Reset classes
            if (type === 'error') {
                element.classList.add('status-error');
            } else if (type === 'success') {
                element.classList.add('status-success');
            } else if (type === 'info') {
                element.classList.add('status-info');
            } else { // 'clear' or invalid type
                element.textContent = ''; // Clear message
            }
        }

        /**
         * Updates the UI visibility based on login status.
         * @param {boolean} isLoggedIn - Whether the user is logged in.
         * @param {string|null} username - The username if logged in.
         */
        function updateUI(isLoggedIn, username = null) {
            // Store login state globally for handleRouteChange or other functions
            // This is a simple way; for more complex apps, a state management pattern is better.
            current_user.is_authenticated = isLoggedIn; 

            if (isLoggedIn) {
                userInfo.textContent = `Logged in as: ${username}`;
                userInfo.classList.remove('hidden');
                logoutButton.classList.remove('hidden');
                showLoginButton.classList.add('hidden');
                showRegisterButton.classList.add('hidden');
                loginSection.classList.add('hidden');
                registerSection.classList.add('hidden');
                // loggedInContent.classList.remove('hidden'); // Old way

                mainNav.classList.remove('hidden'); // Show main navigation
                handleRouteChange(); // Show the correct view based on hash or default

                fetchAndDisplayFiles(); // Fetch files when logged in
                setDefaultDates(); // Set default dates for power curve
            } else {
                userInfo.classList.add('hidden');
                logoutButton.classList.add('hidden');
                showLoginButton.classList.remove('hidden');
                showRegisterButton.classList.remove('hidden');
                loginSection.classList.add('hidden'); 
                registerSection.classList.add('hidden'); 
                // loggedInContent.classList.add('hidden'); // Old way
                
                mainNav.classList.add('hidden'); // Hide main navigation
                // Hide all app views
                Object.values(viewElements).forEach(view => {
                    if (view) view.classList.add('hidden');
                });


                if (powerCurveChart) { 
                    powerCurveChart.destroy();
                    powerCurveChart = null;
                }
            }
        }

        /**
         * Sets default dates for the power curve analysis (e.g., start of year to today).
         */
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const startOfYear = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
            if (startDateInput) startDateInput.value = startOfYear;
            if (endDateInput) endDateInput.value = today;
        }

        // --- API Interaction Functions ---
        // (Keep your existing API functions: checkLoginStatus, handleLogin, handleRegister, handleLogout, 
        // fetchAndDisplayFiles, handleFileUpload, handleFileDelete, handleGeneratePowerCurve, displayChart)
        // Make sure they are defined here. For brevity, I'm omitting them as they don't need direct changes
        // for this view-switching logic, other than how `updateUI` is called.

        // --- Global state (simple approach) ---
        let current_user = { is_authenticated: false };


        /**
         * Checks the current login status with the backend.
         */
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    console.warn(`Login status check failed: ${response.status}`);
                    updateUI(false);
                    return;
                }
                const data = await response.json();
                updateUI(data.logged_in, data.user?.username);
            } catch (error) {
                console.error('Error checking login status:', error);
                setStatusMessage(loginStatusMessage, 'Could not verify login status.', 'error');
                updateUI(false); 
            }
        }

        /**
         * Handles the login form submission.
         * @param {Event} event - The form submission event.
         */
        async function handleLogin(event) {
            event.preventDefault();
            setStatusMessage(loginStatusMessage, 'Logging in...', 'info');
            const formData = new FormData(loginForm);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || `Login failed (status ${response.status})`);
                }
                setStatusMessage(loginStatusMessage, 'Login successful!', 'success');
                loginForm.reset(); 
                setTimeout(() => { 
                    loginSection.classList.add('hidden');
                    setStatusMessage(loginStatusMessage, '', 'clear'); 
                    checkLoginStatus(); 
                }, 1000);
            } catch (error) {
                console.error('Login error:', error);
                setStatusMessage(loginStatusMessage, error.message, 'error');
            }
        }

        /**
         * Handles the registration form submission.
         * @param {Event} event - The form submission event.
         */
        async function handleRegister(event) {
            event.preventDefault();
            setStatusMessage(registerStatusMessage, 'Registering...', 'info');
            const formData = new FormData(registerForm);
            const data = Object.fromEntries(formData.entries());

            if (data.password.length < 6) {
                 setStatusMessage(registerStatusMessage, 'Password must be at least 6 characters.', 'error');
                 return;
            }
             if (data.username.length < 3) {
                 setStatusMessage(registerStatusMessage, 'Username must be at least 3 characters.', 'error');
                 return;
            }

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                if (!response.ok) {
                     throw new Error(result.error || `Registration failed (status ${response.status})`);
                }
                setStatusMessage(registerStatusMessage, 'Registration successful! Please log in.', 'success');
                registerForm.reset();
                 setTimeout(() => { 
                    registerSection.classList.add('hidden');
                    loginSection.classList.remove('hidden'); 
                    setStatusMessage(registerStatusMessage, '', 'clear'); 
                }, 2000);
            } catch (error) {
                console.error('Registration error:', error);
                setStatusMessage(registerStatusMessage, error.message, 'error');
            }
        }

        /**
         * Handles the logout button click.
         */
        async function handleLogout() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                if (!response.ok) {
                    console.warn(`Logout failed (status ${response.status}), assuming session expired.`);
                }
                updateUI(false);
                window.location.hash = ''; // Clear hash on logout
                setStatusMessage(loginStatusMessage, '', 'clear');
                setStatusMessage(registerStatusMessage, '', 'clear');
                setStatusMessage(uploadStatusMessage, '', 'clear');
                setStatusMessage(fileListStatusMessage, '', 'clear');
                setStatusMessage(powerCurveStatusMessage, '', 'clear');

            } catch (error) {
                console.error('Logout error:', error);
                updateUI(false);
                window.location.hash = ''; // Clear hash on logout
            }
        }

        /**
         * Fetches the user's file list and displays it.
         */
        async function fetchAndDisplayFiles() {
            setStatusMessage(fileListStatusMessage, 'Loading files...', 'info');
            fileListContainer.innerHTML = ''; 
            fileListPlaceholder.classList.add('hidden'); 

            try {
                const response = await fetch('/api/files');
                if (!response.ok) {
                    if (response.status === 401) { 
                         updateUI(false); 
                         setStatusMessage(loginStatusMessage, 'Session expired. Please log in again.', 'error');
                         loginSection.classList.remove('hidden');
                         return;
                    }
                    throw new Error(`Failed to fetch files (status ${response.status})`);
                }
                const files = await response.json();

                if (files.length === 0) {
                    fileListContainer.appendChild(fileListPlaceholder); 
                    fileListPlaceholder.classList.remove('hidden');
                    setStatusMessage(fileListStatusMessage, '', 'clear'); 
                } else {
                    files.forEach(file => {
                        const div = document.createElement('div');
                        div.className = 'file-item';

                        const infoSpan = document.createElement('span');
                        infoSpan.textContent = `${file.filename} (${file.date || 'No date'}) - ${file.size_kb ? file.size_kb + ' KB' : 'N/A'}`;
                        infoSpan.className = 'text-sm text-gray-700';

                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = 'Delete';
                        deleteButton.className = 'btn-danger text-xs px-2 py-1 ml-2'; 
                        deleteButton.onclick = () => handleFileDelete(file.id, file.filename);

                        div.appendChild(infoSpan);
                        div.appendChild(deleteButton);
                        fileListContainer.appendChild(div);
                    });
                    setStatusMessage(fileListStatusMessage, '', 'clear'); 
                }
            } catch (error) {
                console.error('Error fetching files:', error);
                setStatusMessage(fileListStatusMessage, 'Could not load file list.', 'error');
                if (!fileListContainer.contains(fileListPlaceholder)) {
                     fileListContainer.appendChild(fileListPlaceholder);
                }
                fileListPlaceholder.classList.remove('hidden');
                fileListPlaceholder.textContent = 'Error loading files.';
            }
        }

        /**
         * Handles the file upload form submission for multiple files.
         * @param {Event} event - The form submission event.
         */
        async function handleFileUpload(event) {
            event.preventDefault();
            const files = fileInput.files; 

            if (!files || files.length === 0) {
                setStatusMessage(uploadStatusMessage, 'Please select one or more files to upload.', 'error');
                return;
            }

            const uploadButtonRef = document.getElementById('uploadButton'); // Renamed to avoid conflict
            uploadButtonRef.disabled = true;
            let successCount = 0;
            let errorCount = 0;
            const totalFiles = files.length;

            setStatusMessage(uploadStatusMessage, `Starting upload of ${totalFiles} file(s)...`, 'info');

            const uploadPromises = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                if (!file.name.toLowerCase().endsWith('.fit')) {
                    console.warn(`Skipping non-FIT file: ${file.name}`);
                    errorCount++; 
                    setStatusMessage(uploadStatusMessage, `Uploading ${i + 1}/${totalFiles}... Skipping non-FIT file: ${file.name}`, 'info');
                    continue; 
                }

                const formData = new FormData();
                formData.append('file', file);

                const uploadPromise = fetch('/api/files', {
                    method: 'POST',
                    body: formData,
                })
                .then(async response => {
                    const result = await response.json().catch(() => ({})); 
                    if (!response.ok) {
                        throw new Error(result.error || `Upload failed for ${file.name} (status ${response.status})`);
                    }
                    console.log(`Successfully uploaded ${file.name}`);
                    successCount++;
                    setStatusMessage(uploadStatusMessage, `Uploading ${i + 1}/${totalFiles}... Success: ${file.name}`, 'info');
                    return { success: true, filename: file.name };
                })
                .catch(error => {
                    console.error(`Upload error for ${file.name}:`, error);
                    errorCount++;
                    setStatusMessage(uploadStatusMessage, `Uploading ${i + 1}/${totalFiles}... Error: ${file.name}`, 'info');
                    return { success: false, filename: file.name, error: error.message };
                });

                uploadPromises.push(uploadPromise);
            }

            await Promise.allSettled(uploadPromises);

            let finalMessage = `Upload complete. ${successCount} succeeded, ${errorCount} failed/skipped.`;
            setStatusMessage(uploadStatusMessage, finalMessage, errorCount > 0 ? 'error' : 'success');

            uploadForm.reset(); 
            uploadButtonRef.disabled = false;
            fetchAndDisplayFiles(); 
        }


        /**
         * Handles the deletion of a file.
         * @param {number} fileId - The ID of the file to delete.
         * @param {string} filename - The name of the file (for confirmation).
         */
        async function handleFileDelete(fileId, filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }
            setStatusMessage(fileListStatusMessage, `Deleting ${filename}...`, 'info');
            try {
                const response = await fetch(`/api/files/${fileId}`, {
                    method: 'DELETE',
                });
                const result = await response.json(); 
                if (!response.ok) {
                     throw new Error(result.error || `Deletion failed (status ${response.status})`);
                }
                setStatusMessage(fileListStatusMessage, `File '${filename}' deleted.`, 'success');
                fetchAndDisplayFiles(); 
            } catch (error) {
                console.error('Delete error:', error);
                setStatusMessage(fileListStatusMessage, error.message, 'error');
            }
        }

        /**
         * Handles the request to generate the power curve.
         */
        async function handleGeneratePowerCurve() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate || !endDate) {
                setStatusMessage(powerCurveStatusMessage, 'Please select both a start and end date.', 'error');
                return;
            }
            if (new Date(startDate) > new Date(endDate)) {
                 setStatusMessage(powerCurveStatusMessage, 'Start date cannot be after end date.', 'error');
                 return;
            }

            setStatusMessage(powerCurveStatusMessage, 'Generating power curve...', 'info');
            generateButton.disabled = true;

            try {
                const response = await fetch('/api/powercurve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startDate, endDate }),
                });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP error! status: ${response.status}`);
                }

                if (Object.keys(result).length === 0) {
                    setStatusMessage(powerCurveStatusMessage, 'No valid power data found for the selected date range.', 'info');
                     if (powerCurveChart) {
                         powerCurveChart.destroy();
                         powerCurveChart = null;
                     }
                } else {
                   displayChart(result); 
                   setStatusMessage(powerCurveStatusMessage, 'Power curve generated.', 'success');
                }

            } catch (error) {
                console.error('Error fetching or processing power curve:', error);
                setStatusMessage(powerCurveStatusMessage, `Error: ${error.message}`, 'error');
                 if (powerCurveChart) {
                     powerCurveChart.destroy();
                     powerCurveChart = null;
                 }
            } finally {
                 generateButton.disabled = false;
            }
        }

        /**
         * Initializes or updates the power curve chart.
         * @param {object} powerData - The power curve data { duration: power }.
         */
        function displayChart(powerData) {
            const ctx = powerCurveChartElement.getContext('2d');

            const sortedDurations = Object.keys(powerData).map(Number).sort((a, b) => a - b);
            const labels = sortedDurations.map(String);
            const dataPoints = sortedDurations.map(duration => powerData[duration.toString()]);

            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Max Average Power',
                        data: dataPoints,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: false,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Duration (seconds)', font: { size: 14 } },
                            ticks: {
                                 callback: function(value, index, values) {
                                    const commonTicks = [1, 5, 10, 30, 60, 300, 600, 1200, 1800, 3600, 5400];
                                    const numericValue = Number(this.getLabelForValue(value));
                                    if (commonTicks.includes(numericValue) || Math.log10(numericValue) % 1 === 0) {
                                        return numericValue + 's';
                                    }
                                    return null;
                                 },
                                 autoSkip: false,
                                 maxRotation: 45,
                                 minRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: false, 
                            title: { display: true, text: 'Max Average Power (watts)', font: { size: 14 } }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) { return 'Duration: ' + tooltipItems[0].label + 's'; },
                                label: function(tooltipItem) { return 'Max Avg Power: ' + Math.round(tooltipItem.raw) + ' W'; }
                            }
                        },
                        legend: { display: true, position: 'top' }
                    }
                }
            };

            if (powerCurveChart) {
                powerCurveChart.data.labels = labels;
                powerCurveChart.data.datasets[0].data = dataPoints;
                powerCurveChart.update();
            } else {
                powerCurveChart = new Chart(ctx, chartConfig);
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus(); // Check status on page load

            showLoginButton.addEventListener('click', () => {
                registerSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
                setStatusMessage(loginStatusMessage, '', 'clear'); 
            });

            showRegisterButton.addEventListener('click', () => {
                loginSection.classList.add('hidden');
                registerSection.classList.remove('hidden');
                 setStatusMessage(registerStatusMessage, '', 'clear'); 
            });

            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutButton.addEventListener('click', handleLogout);
            uploadForm.addEventListener('submit', handleFileUpload); 
            generateButton.addEventListener('click', handleGeneratePowerCurve);

            // Listen for hash changes to switch views
            window.addEventListener('hashchange', handleRouteChange);
        });

    </script>

</body>
</html>
