<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT File Power Curve Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* Basic body styling */
        body { font-family: 'Inter', sans-serif; }
        /* Ensure canvas is responsive */
        .chart-container {
            position: relative;
            margin: 1rem auto; /* Reduced margin for tighter layout */
            height: 60vh;
            width: 90vw; /* Slightly wider */
            max-width: 1000px; /* Increased max-width */
        }
        /* Style for loading/error/status messages */
        .status-message {
            min-height: 1.5em; /* Reserve space */
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 500;
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
        }
        .status-error { background-color: #fee2e2; color: #dc2626; } /* red-100 / red-600 */
        .status-success { background-color: #dcfce7; color: #16a34a; } /* green-100 / green-600 */
        .status-info { background-color: #e0f2fe; color: #0284c7; } /* sky-100 / sky-600 */

        /* Hide elements by default */
        .hidden { display: none; }

        /* Basic button styling */
        button, input[type="submit"], select {
            transition: background-color 0.2s ease;
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 1rem;
            font-weight: 600;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            border: 1px solid #d1d5db; /* gray-300 for select */
        }
        select { padding: 0.5rem 0.75rem; } /* Specific padding for select */

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-primary { background-color: #4f46e5; color: white; border-color: transparent; } /* indigo-600 */
        .btn-primary:hover:not(:disabled) { background-color: #4338ca; } /* indigo-700 */
        .btn-secondary { background-color: #e5e7eb; color: #374151; } /* gray-200 / gray-700 */
        .btn-secondary:hover:not(:disabled) { background-color: #d1d5db; } /* gray-300 */
        .btn-danger { background-color: #dc2626; color: white; border-color: transparent;} /* red-600 */
        .btn-danger:hover:not(:disabled) { background-color: #b91c1c; } /* red-700 */

        /* Input field styling */
        input[type="text"], input[type="password"], input[type="date"], input[type="file"] {
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem 0.75rem;
            width: 100%;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        input[type="file"] { padding: 0.3rem 0.75rem; }
        input:focus, select:focus { outline: 2px solid transparent; outline-offset: 2px; border-color: #6366f1; box-shadow: 0 0 0 2px #a5b4fc; } /* indigo-500 focus */

        /* Style for file list items */
        .file-item, .plotted-range-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .file-item:last-child, .plotted-range-item:last-child { border-bottom: none; }
        .plotted-range-item span { flex-grow: 1; }

        /* Styling for active navigation button */
        .nav-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: transparent;
        }
        .nav-button {
            margin-right: 0.5rem; /* Add some spacing between nav buttons */
        }
         /* Ensure chart legend items are clickable */
        .chartjs-legend ul li { cursor: pointer; }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <header class="flex justify-between items-center mb-6 max-w-5xl mx-auto">
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Power Curve Analyzer</h1>
        <div id="userStatusArea">
            <span id="userInfo" class="hidden mr-4 text-gray-700"></span>
            <button id="logoutButton" class="btn-secondary hidden">Logout</button>
            <button id="showLoginButton" class="btn-primary">Login</button>
            <button id="showRegisterButton" class="btn-secondary ml-2">Register</button>
        </div>
    </header>

    <main class="max-w-5xl mx-auto">

        <section id="loginSection" class="hidden max-w-sm mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">Login</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="loginUsername" class="block text-sm font-medium text-gray-600 mb-1">Username:</label>
                    <input type="text" id="loginUsername" name="username" required autocomplete="username">
                </div>
                <div class="mb-4">
                    <label for="loginPassword" class="block text-sm font-medium text-gray-600 mb-1">Password:</label>
                    <input type="password" id="loginPassword" name="password" required autocomplete="current-password">
                </div>
                <button type="submit" class="btn-primary w-full">Login</button>
                <div id="loginStatusMessage" class="status-message"></div>
            </form>
        </section>

        <section id="registerSection" class="hidden max-w-sm mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 text-center">Register</h2>
            <form id="registerForm">
                <div class="mb-4">
                    <label for="registerUsername" class="block text-sm font-medium text-gray-600 mb-1">Username:</label>
                    <input type="text" id="registerUsername" name="username" required minlength="3" autocomplete="username">
                </div>
                <div class="mb-4">
                    <label for="registerPassword" class="block text-sm font-medium text-gray-600 mb-1">Password:</label>
                    <input type="password" id="registerPassword" name="password" required minlength="6" autocomplete="new-password">
                </div>
                <button type="submit" class="btn-primary w-full">Register</button>
                <div id="registerStatusMessage" class="status-message"></div>
            </form>
        </section>

        <nav id="mainNav" class="hidden mb-6 pb-2 border-b border-gray-300">
            <button data-view="files" class="nav-button btn-secondary">File Management</button>
            <button data-view="powercurve" class="nav-button btn-secondary">Power Curve Analysis</button>
        </nav>

        <div id="appViews">
            <section id="filesView" class="view-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">File Management</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Upload FIT Files</h3>
                        <form id="uploadForm">
                            <div class="mb-4">
                                <label for="fileInput" class="block text-sm font-medium text-gray-600 mb-1">Select .fit file(s):</label>
                                <input type="file" id="fileInput" name="file" accept=".fit" required multiple
                                       class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                            <button type="submit" id="uploadButton" class="btn-primary w-full">Upload Selected Files</button>
                            <div id="uploadStatusMessage" class="status-message"></div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold mb-4 text-gray-700">Your Uploaded Files</h3>
                        <div id="fileListContainer" class="max-h-60 overflow-y-auto">
                            <p id="fileListPlaceholder" class="text-gray-500 text-center py-4">No files uploaded yet.</p>
                        </div>
                        <div id="fileListStatusMessage" class="status-message"></div>
                    </div>
                </div>
            </section>

            <section id="powerCurveView" class="view-section hidden">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Power Curve Analysis</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-700">Add Date Ranges to Chart</h3>
                    
                    <div class="mb-6 p-4 border border-gray-200 rounded-md">
                        <h4 class="text-md font-semibold mb-2 text-gray-600">Premade Ranges</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="premadeRangeSelect" class="block text-sm font-medium text-gray-600 mb-1">Select Range:</label>
                                <select id="premadeRangeSelect" class="w-full">
                                    <option value="last3months">Last 3 Months</option>
                                    <option value="last6months">Last 6 Months</option>
                                    <option value="last12months">Last 12 Months</option>
                                    </select>
                            </div>
                            <button id="addPremadeRangeButton" class="btn-secondary w-full sm:col-span-2 md:col-span-1">Add Premade Range</button>
                        </div>
                    </div>

                    <div class="mb-6 p-4 border border-gray-200 rounded-md">
                        <h4 class="text-md font-semibold mb-2 text-gray-600">Custom Range</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-600 mb-1">Start Date:</label>
                                <input type="date" id="startDate" name="startDate" required>
                            </div>
                            <div>
                                <label for="endDate" class="block text-sm font-medium text-gray-600 mb-1">End Date:</label>
                                <input type="date" id="endDate" name="endDate" required>
                            </div>
                            <button id="addCustomRangeButton" class="btn-primary w-full">Add Custom Range</button>
                        </div>
                    </div>
                    <div id="powerCurveStatusMessage" class="status-message mb-4"></div>

                     <div class="mb-4">
                        <h4 class="text-md font-semibold mb-2 text-gray-600">Currently Plotted Ranges:</h4>
                        <div id="plottedRangesList" class="max-h-40 overflow-y-auto bg-gray-50 p-2 rounded-md border border-gray-200">
                            <p id="plottedRangesPlaceholder" class="text-gray-400 text-sm text-center py-2">No ranges plotted yet.</p>
                        </div>
                         <div id="plottedRangesStatusMessage" class="status-message"></div>
                    </div>
                    <button id="clearChartButton" class="btn-danger w-full mt-2">Clear All Curves</button>
                </div>

                <div class="chart-container bg-white p-4 rounded-lg shadow-md">
                    <canvas id="powerCurveChart"></canvas>
                </div>
            </section>
        </div>
    </main>

    <script>
        // --- DOM Elements ---
        const userStatusArea = document.getElementById('userStatusArea');
        const userInfo = document.getElementById('userInfo');
        const logoutButton = document.getElementById('logoutButton');
        const showLoginButton = document.getElementById('showLoginButton');
        const showRegisterButton = document.getElementById('showRegisterButton');
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const uploadForm = document.getElementById('uploadForm');
        const loginStatusMessage = document.getElementById('loginStatusMessage');
        const registerStatusMessage = document.getElementById('registerStatusMessage');
        const uploadStatusMessage = document.getElementById('uploadStatusMessage');
        const fileListStatusMessage = document.getElementById('fileListStatusMessage');
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileListPlaceholder = document.getElementById('fileListPlaceholder');

        // --- View Management Elements ---
        const mainNav = document.getElementById('mainNav');
        const appViewsContainer = document.getElementById('appViews');
        const viewElements = {
            files: document.getElementById('filesView'),
            powercurve: document.getElementById('powerCurveView')
        };
        const navButtons = mainNav.querySelectorAll('.nav-button');

        // --- Power Curve View Specific Elements ---
        const premadeRangeSelect = document.getElementById('premadeRangeSelect');
        const addPremadeRangeButton = document.getElementById('addPremadeRangeButton');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const addCustomRangeButton = document.getElementById('addCustomRangeButton');
        const powerCurveStatusMessage = document.getElementById('powerCurveStatusMessage');
        const plottedRangesList = document.getElementById('plottedRangesList');
        const plottedRangesPlaceholder = document.getElementById('plottedRangesPlaceholder');
        const plottedRangesStatusMessage = document.getElementById('plottedRangesStatusMessage');
        const clearChartButton = document.getElementById('clearChartButton');
        const powerCurveChartElement = document.getElementById('powerCurveChart');

        // --- State Variables ---
        let powerCurveChart = null;
        let current_user = { is_authenticated: false }; // Global state for login status
        let plottedCurvesData = []; 
        const chartColors = [ 
            'rgb(75, 192, 192)', 'rgb(255, 99, 132)', 'rgb(54, 162, 235)',
            'rgb(255, 206, 86)', 'rgb(153, 102, 255)', 'rgb(255, 159, 64)',
            'rgb(123, 239, 178)', 'rgb(247, 159, 31)', 'rgb(106, 176, 76)', 'rgb(196, 229, 56)'
        ];
        let nextColorIndex = 0;

        // --- Helper Functions ---
        function getNextColor() {
            const color = chartColors[nextColorIndex % chartColors.length];
            nextColorIndex++;
            return color;
        }

        function formatDate(date) { 
            return date.toISOString().split('T')[0];
        }

        function populateYearOptions() {
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 5; i++) { // Populate with last 5 years
                const year = currentYear - i;
                const option = document.createElement('option');
                option.value = `year_${year}`;
                option.textContent = `Year: ${year}`;
                premadeRangeSelect.appendChild(option);
            }
        }
        
        function setStatusMessage(element, message, type = 'info') {
            if (!element) return;
            element.textContent = message;
            element.className = 'status-message'; 
            if (type === 'error') element.classList.add('status-error');
            else if (type === 'success') element.classList.add('status-success');
            else if (type === 'info') element.classList.add('status-info');
            else element.textContent = ''; // Clear if type is 'clear' or invalid
        }

        // --- View Management ---
        function showView(viewNameParam) {
            let effectiveViewName = viewNameParam;
            let viewElementToShow = viewElements[effectiveViewName];

            if (!viewElementToShow) {
                console.warn(`View "${effectiveViewName}" not found. Defaulting to "files".`);
                effectiveViewName = 'files';
                viewElementToShow = viewElements.files; 
            }
            
            Object.values(viewElements).forEach(view => {
                if (view) view.classList.add('hidden');
            });

            if (viewElementToShow) {
                viewElementToShow.classList.remove('hidden');
            } else {
                console.error("Default view 'filesView' also not found.");
                return; 
            }

            const currentHash = window.location.hash.substring(1);
            if (currentHash !== effectiveViewName) {
                window.location.hash = effectiveViewName;
            }

            navButtons.forEach(button => {
                const isActive = button.dataset.view === effectiveViewName;
                button.classList.toggle('active', isActive);
                button.classList.toggle('btn-primary', isActive);
                button.classList.toggle('btn-secondary', !isActive);
            });

            if (effectiveViewName === 'powercurve') { 
                setDefaultDatesForCustomRange(); 
            }
        }

        function handleRouteChange() {
            // This function is called on 'hashchange' and after login.
            // It should only proceed to show a view if the user is authenticated.
            if (!current_user.is_authenticated) {
                // If not authenticated, ensure no main app views are shown.
                // The updateUI function handles hiding mainNav and app views on logout.
                return; 
            }
            const hash = window.location.hash.substring(1);
            showView(hash || 'files'); // Default to 'files' view if hash is empty and user is logged in
        }

        // --- UI Update Functions ---
        function updateUI(isLoggedIn, username = null) {
            current_user.is_authenticated = isLoggedIn; // Update global login state

            // Toggle visibility of auth-related elements in the header
            userInfo.classList.toggle('hidden', !isLoggedIn);
            if (isLoggedIn) userInfo.textContent = `Logged in as: ${username}`;
            logoutButton.classList.toggle('hidden', !isLoggedIn);
            showLoginButton.classList.toggle('hidden', isLoggedIn);
            showRegisterButton.classList.toggle('hidden', isLoggedIn);

            // Always hide login/register forms after this initial setup
            loginSection.classList.add('hidden');
            registerSection.classList.add('hidden');
            
            mainNav.classList.toggle('hidden', !isLoggedIn); // Show/hide main navigation

            if (isLoggedIn) {
                // User is now logged in, handle routing to the correct view
                handleRouteChange(); // This will show the default view ('files') or current hash view
                fetchAndDisplayFiles(); // Fetch files relevant to the logged-in user
            } else {
                // User is not logged in (or logged out)
                Object.values(viewElements).forEach(view => view && view.classList.add('hidden')); // Hide all app views
                if (powerCurveChart) {
                    powerCurveChart.destroy();
                    powerCurveChart = null;
                }
                plottedCurvesData = []; 
                nextColorIndex = 0; 
                updatePlottedRangesUI(); 
                // Ensure login/register buttons are visible if no specific form is requested
                // (Handled by showLoginButton/showRegisterButton toggles above)
            }
        }
        
        function setDefaultDatesForCustomRange() {
            const today = new Date();
            const oneMonthAgo = new Date(new Date().setMonth(today.getMonth() - 1));
            if (startDateInput) startDateInput.value = formatDate(oneMonthAgo);
            if (endDateInput) endDateInput.value = formatDate(today);
        }

        function updatePlottedRangesUI() {
            plottedRangesList.innerHTML = ''; 
            if (plottedCurvesData.length === 0) {
                plottedRangesList.appendChild(plottedRangesPlaceholder);
                plottedRangesPlaceholder.classList.remove('hidden');
            } else {
                plottedRangesPlaceholder.classList.add('hidden');
                plottedCurvesData.forEach(curve => {
                    const div = document.createElement('div');
                    div.className = 'plotted-range-item text-sm';
                    const colorIndicator = document.createElement('span');
                    colorIndicator.style.display = 'inline-block';
                    colorIndicator.style.width = '12px';
                    colorIndicator.style.height = '12px';
                    colorIndicator.style.backgroundColor = curve.color;
                    colorIndicator.style.marginRight = '8px';
                    colorIndicator.style.borderRadius = '2px';
                    const textSpan = document.createElement('span');
                    textSpan.textContent = `${curve.label} (${curve.startDate} to ${curve.endDate})`;
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remove';
                    removeBtn.className = 'btn-danger text-xs px-2 py-1 ml-2';
                    removeBtn.onclick = () => removeCurveFromChart(curve.id);
                    div.appendChild(colorIndicator);
                    div.appendChild(textSpan);
                    div.appendChild(removeBtn);
                    plottedRangesList.appendChild(div);
                });
            }
        }

        // --- Power Curve Logic ---
        async function addRangeToChart(rangeType, customStart, customEnd) {
            let startDate, endDate, label, rangeId;
            const today = new Date();

            switch(rangeType) {
                case 'last3months':
                    endDate = formatDate(today);
                    startDate = formatDate(new Date(new Date().setMonth(today.getMonth() - 3)));
                    label = 'Last 3 Months';
                    rangeId = 'last3months';
                    break;
                case 'last6months':
                    endDate = formatDate(today);
                    startDate = formatDate(new Date(new Date().setMonth(today.getMonth() - 6)));
                    label = 'Last 6 Months';
                    rangeId = 'last6months';
                    break;
                case 'last12months':
                    endDate = formatDate(today);
                    startDate = formatDate(new Date(new Date().setMonth(today.getMonth() - 12)));
                    label = 'Last 12 Months';
                    rangeId = 'last12months';
                    break;
                default: 
                    if (rangeType.startsWith('year_')) {
                        const year = parseInt(rangeType.split('_')[1]);
                        startDate = `${year}-01-01`;
                        endDate = `${year}-12-31`;
                        label = `Year ${year}`;
                        rangeId = `year_${year}`;
                    } else if (rangeType === 'custom') {
                        startDate = customStart;
                        endDate = customEnd;
                        if (!startDate || !endDate) { setStatusMessage(powerCurveStatusMessage, 'Custom range requires start and end dates.', 'error'); return; }
                        if (new Date(startDate) > new Date(endDate)) { setStatusMessage(powerCurveStatusMessage, 'Start date cannot be after end date for custom range.', 'error'); return; }
                        label = `Custom: ${startDate} to ${endDate}`;
                        rangeId = `custom_${startDate}_${endDate}`;
                    } else { setStatusMessage(powerCurveStatusMessage, 'Invalid range type selected.', 'error'); return; }
            }

            if (plottedCurvesData.some(curve => curve.id === rangeId)) {
                setStatusMessage(powerCurveStatusMessage, `Range "${label}" is already plotted.`, 'info');
                return;
            }

            setStatusMessage(powerCurveStatusMessage, `Fetching data for ${label}...`, 'info');
            addCustomRangeButton.disabled = true;
            addPremadeRangeButton.disabled = true;

            try {
                const response = await fetch('/api/powercurve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ startDate, endDate }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || `HTTP error! Status: ${response.status}`);
                if (Object.keys(result).length === 0) {
                    setStatusMessage(powerCurveStatusMessage, `No power data found for ${label}.`, 'info');
                } else {
                    plottedCurvesData.push({ id: rangeId, label, startDate, endDate, powerData: result, color: getNextColor() });
                    updatePlottedRangesUI();
                    renderChart();
                    setStatusMessage(powerCurveStatusMessage, `Added ${label} to chart.`, 'success');
                }
            } catch (error) {
                console.error(`Error fetching power curve for ${label}:`, error);
                setStatusMessage(powerCurveStatusMessage, `Error for ${label}: ${error.message}`, 'error');
            } finally {
                addCustomRangeButton.disabled = false;
                addPremadeRangeButton.disabled = false;
            }
        }

        function removeCurveFromChart(rangeId) {
            plottedCurvesData = plottedCurvesData.filter(curve => curve.id !== rangeId);
            updatePlottedRangesUI();
            renderChart();
        }

        function clearAllCurves() {
            plottedCurvesData = [];
            nextColorIndex = 0; 
            updatePlottedRangesUI();
            if (powerCurveChart) { 
                powerCurveChart.destroy();
                powerCurveChart = null;
            }
            renderChart(); 
            setStatusMessage(powerCurveStatusMessage, 'Chart cleared.', 'info');
        }
        
        function renderChart() {
            const ctx = powerCurveChartElement.getContext('2d');
            const datasets = plottedCurvesData.map(curve => {
                const sortedDurations = Object.keys(curve.powerData).map(Number).sort((a, b) => a - b);
                const dataPoints = sortedDurations.map(duration => curve.powerData[duration.toString()]);
                return {
                    label: curve.label, data: dataPoints, borderColor: curve.color,
                    backgroundColor: curve.color.replace('rgb(', 'rgba(').replace(')', ', 0.1)'), 
                    tension: 0.1, fill: plottedCurvesData.length === 1, 
                    pointRadius: 3, pointHoverRadius: 5, borderWidth: 2
                };
            });
            const allDurations = new Set();
            plottedCurvesData.forEach(curve => { Object.keys(curve.powerData).forEach(duration => allDurations.add(Number(duration))); });
            const sortedUniqueDurations = Array.from(allDurations).sort((a, b) => a - b).map(String);

            if (powerCurveChart) {
                powerCurveChart.data.labels = sortedUniqueDurations;
                powerCurveChart.data.datasets = datasets;
                powerCurveChart.update();
            } else {
                if (datasets.length > 0) { 
                    powerCurveChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels: sortedUniqueDurations, datasets: datasets, },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'logarithmic', title: { display: true, text: 'Duration (seconds)', font: { size: 14 } },
                                    ticks: {
                                        callback: function(value, index, values) {
                                            const commonTicks = [1, 2, 3, 5, 10, 15, 20, 30, 45, 60, 90, 120, 180, 240, 300, 420, 600, 900, 1200, 1800, 2700, 3600, 5400];
                                            const numericValue = Number(this.getLabelForValue(value));
                                            if (commonTicks.includes(numericValue)) return numericValue + 's';
                                            if (Math.log10(numericValue) % 1 === 0 && numericValue > 0) return numericValue + 's';
                                            return null;
                                        },
                                        autoSkip: false, maxRotation: 45, minRotation: 0
                                    }
                                },
                                y: { beginAtZero: false, title: { display: true, text: 'Max Average Power (watts)', font: { size: 14 } } }
                            },
                            plugins: {
                                tooltip: { callbacks: { title: function(tooltipItems) { return 'Duration: ' + tooltipItems[0].label + 's'; }, label: function(tooltipItem) { return `${tooltipItem.dataset.label}: ${Math.round(tooltipItem.raw)} W`; } } },
                                legend: { display: true, position: 'top', labels: { usePointStyle: true } }
                            }
                        }
                    });
                }
            }
        }

        // --- API Interaction Functions ---
        async function checkLoginStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) { 
                    console.warn(`Login status check failed: ${response.status}`);
                    updateUI(false); // Assume logged out if status check fails
                    return;
                }
                const data = await response.json();
                updateUI(data.logged_in, data.user?.username);
            } catch (error) {
                console.error('Error checking login status:', error);
                setStatusMessage(loginStatusMessage, 'Could not verify login status.', 'error');
                updateUI(false); // Assume logged out on network error
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            setStatusMessage(loginStatusMessage, 'Logging in...', 'info');
            const formData = new FormData(loginForm);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || `Login failed (status ${response.status})`);
                }
                // Login was successful on the backend
                setStatusMessage(loginStatusMessage, 'Login successful!', 'success');
                loginForm.reset();
                // loginSection.classList.add('hidden'); // This is now handled by updateUI

                // Directly update UI for logged-in state
                updateUI(true, result.username); 

            } catch (error) {
                console.error('Login error:', error);
                setStatusMessage(loginStatusMessage, error.message, 'error');
                updateUI(false); // Ensure UI reflects logged-out state on login error
            }
        }
        
        async function handleRegister(e){e.preventDefault(),setStatusMessage(registerStatusMessage,"Registering...","info");const t=new FormData(registerForm),s=Object.fromEntries(t.entries());if(s.password.length<6)return void setStatusMessage(registerStatusMessage,"Password must be at least 6 characters.","error");if(s.username.length<3)return void setStatusMessage(registerStatusMessage,"Username must be at least 3 characters.","error");try{const e=await fetch("/api/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}),t=await e.json();if(!e.ok)throw new Error(t.error||`Registration failed (status ${e.status})`);setStatusMessage(registerStatusMessage,"Registration successful! Please log in.","success"),registerForm.reset(),setTimeout(()=>{registerSection.classList.add("hidden"),loginSection.classList.remove("hidden"),setStatusMessage(registerStatusMessage,"","clear")},2e3)}catch(e){console.error("Registration error:",e),setStatusMessage(registerStatusMessage,e.message,"error")}}
        async function handleLogout(){try{const e=await fetch("/api/logout",{method:"POST"});e.ok||console.warn(`Logout failed (status ${e.status}), assuming session expired.`)}catch(e){console.error("Logout error:",e)}finally{updateUI(!1),window.location.hash="",[loginStatusMessage,registerStatusMessage,uploadStatusMessage,fileListStatusMessage,powerCurveStatusMessage,plottedRangesStatusMessage].forEach(e=>setStatusMessage(e,"","clear"))}}
        async function fetchAndDisplayFiles(){setStatusMessage(fileListStatusMessage,"Loading files...","info"),fileListContainer.innerHTML="",fileListPlaceholder.classList.add("hidden");try{const e=await fetch("/api/files");if(!e.ok){if(401===e.status)return updateUI(!1),setStatusMessage(loginStatusMessage,"Session expired. Please log in again.","error"),void loginSection.classList.remove("hidden");throw new Error(`Failed to fetch files (status ${e.status})`)}const t=await e.json();if(0===t.length)fileListContainer.appendChild(fileListPlaceholder),fileListPlaceholder.classList.remove("hidden"),setStatusMessage(fileListStatusMessage,"","clear");else{t.forEach(e=>{const t=document.createElement("div");t.className="file-item";const s=document.createElement("span");s.textContent=`${e.filename} (${e.date||"No date"}) - ${e.size_kb?e.size_kb+" KB":"N/A"}`,s.className="text-sm text-gray-700";const n=document.createElement("button");n.textContent="Delete",n.className="btn-danger text-xs px-2 py-1 ml-2",n.onclick=()=>handleFileDelete(e.id,e.filename),t.appendChild(s),t.appendChild(n),fileListContainer.appendChild(t)}),setStatusMessage(fileListStatusMessage,"","clear")}}catch(e){console.error("Error fetching files:",e),setStatusMessage(fileListStatusMessage,"Could not load file list.","error"),fileListContainer.contains(fileListPlaceholder)||fileListContainer.appendChild(fileListPlaceholder),fileListPlaceholder.classList.remove("hidden"),fileListPlaceholder.textContent="Error loading files."}}
        async function handleFileUpload(e){e.preventDefault();const t=fileInput.files;if(!t||0===t.length)return void setStatusMessage(uploadStatusMessage,"Please select one or more files to upload.","error");const s=document.getElementById("uploadButton");s.disabled=!0;let n=0,o=0;const i=t.length;setStatusMessage(uploadStatusMessage,`Starting upload of ${i} file(s)...`,"info");const r=[];for(let e=0;e<i;e++){const i=t[e];if(!i.name.toLowerCase().endsWith(".fit")){console.warn(`Skipping non-FIT file: ${i.name}`),o++,setStatusMessage(uploadStatusMessage,`Uploading ${e+1}/${i /* Corrected from totalFiles which is not defined here */}... Skipping non-FIT file: ${i.name}`,"info");continue}const a=new FormData;a.append("file",i);const l=fetch("/api/files",{method:"POST",body:a}).then(async e=>{const t=await e.json().catch(()=>({}));if(!e.ok)throw new Error(t.error||`Upload failed for ${i.name} (status ${e.status})`);return console.log(`Successfully uploaded ${i.name}`),n++,setStatusMessage(uploadStatusMessage,`Uploading ${e+1}/${i /* Corrected */}... Success: ${i.name}`,"info"),{success:!0,filename:i.name}}).catch(e=>(console.error(`Upload error for ${i.name}:`,e),o++,setStatusMessage(uploadStatusMessage,`Uploading ${e+1}/${i /* Corrected */}... Error: ${i.name}`,"info"),{success:!1,filename:i.name,error:e.message}));r.push(l)}await Promise.allSettled(r);let a=`Upload complete. ${n} succeeded, ${o} failed/skipped.`;setStatusMessage(uploadStatusMessage,a,o>0?"error":"success"),uploadForm.reset(),s.disabled=!1,fetchAndDisplayFiles()}
        async function handleFileDelete(e,t){if(!confirm(`Are you sure you want to delete "${t}"?`))return;setStatusMessage(fileListStatusMessage,`Deleting ${t}...`,"info");try{const s=await fetch(`/api/files/${e}`,{method:"DELETE"}),n=await s.json();if(!s.ok)throw new Error(n.error||`Deletion failed (status ${s.status})`);setStatusMessage(fileListStatusMessage,`File '${t}' deleted.`,"success"),fetchAndDisplayFiles()}catch(e){console.error("Delete error:",e),setStatusMessage(fileListStatusMessage,e.message,"error")}}

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus(); // Initial check on page load
            populateYearOptions(); 

            showLoginButton.addEventListener('click', () => { registerSection.classList.add('hidden'); loginSection.classList.remove('hidden'); setStatusMessage(loginStatusMessage, '', 'clear'); });
            showRegisterButton.addEventListener('click', () => { loginSection.classList.add('hidden'); registerSection.classList.remove('hidden'); setStatusMessage(registerStatusMessage, '', 'clear'); });
            loginForm.addEventListener('submit', handleLogin);
            registerForm.addEventListener('submit', handleRegister);
            logoutButton.addEventListener('click', handleLogout);
            uploadForm.addEventListener('submit', handleFileUpload);
            
            addPremadeRangeButton.addEventListener('click', () => {
                const selectedRangeType = premadeRangeSelect.value;
                addRangeToChart(selectedRangeType);
            });
            addCustomRangeButton.addEventListener('click', () => {
                addRangeToChart('custom', startDateInput.value, endDateInput.value);
            });
            clearChartButton.addEventListener('click', clearAllCurves);

            window.addEventListener('hashchange', handleRouteChange);
            
            if (mainNav) {
                 mainNav.addEventListener('click', (event) => {
                    const targetButton = event.target.closest('button[data-view]');
                    if (targetButton) {
                        const viewName = targetButton.dataset.view;
                        showView(viewName);
                    }
                });
            }
        });
    </script>

</body>
</html>
